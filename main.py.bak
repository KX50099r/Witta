from fastapi import FastAPI, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
import asyncio
import logging
from pathlib import Path
from contextlib import asynccontextmanager
import sys

# Dynamically add the witta-core directory to sys.path
sys.path.append(str(Path(__file__).resolve().parent / "witta-core"))

from app.core.orchestrator import main as orchestrator_main

# Configure logging
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s - %(message)s",
    handlers=[
        logging.StreamHandler(sys.stdout)
    ]
)

logger = logging.getLogger("witta")

# Use a lifespan event handler to start and stop the orchestrator
@asynccontextmanager
async def lifespan(app: FastAPI):
    # Startup logic
    logger.info("Starting Witta server...")
    orchestrator_task = asyncio.create_task(orchestrator_main.run())  # Run orchestrator
    app.state.orchestrator_task = orchestrator_task
    yield
    # Shutdown logic
    logger.info("Shutting down Witta server...")
    orchestrator_task.cancel()
    try:
        await orchestrator_task  # Wait for the task to complete
    except asyncio.CancelledError:
        logger.info("Orchestrator task cancelled gracefully.")

# Initialize FastAPI app
app = FastAPI(lifespan=lifespan)

# Add CORS middleware
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Define API endpoints
@app.get("/")
async def read_root():
    return {"message": "Welcome to Witta API"}

@app.get("/health")
async def health_check():
    return {"status": "healthy"}
